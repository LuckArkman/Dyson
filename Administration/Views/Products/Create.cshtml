@using Enums
@model Dtos.Product

<div class="card card-primary">
    <div class="card-header">
        <h3 class="card-title">Cadastro de Produto</h3>
    </div>
    <form asp-action="Create" id="formProduct">
        <div class="card-body">
            
            <!-- (MANTENHA OS CAMPOS DE NOME, DESCRIÇÃO E PREÇO QUE JÁ FIZEMOS) -->
            <div class="form-group">
                <label>Nome do Produto</label>
                <input asp-for="name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Descrição</label>
                <textarea asp-for="description" class="form-control" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <select asp-for="category" class="form-control" asp-items="Html.GetEnumSelectList<ProductCategory>()"></select>
            </div>

            <!-- ... Bloco de Preços (Código anterior) ... -->
             <hr />
            <h4>Preços</h4>
            <div class="row mb-4">
                @{ var pricesList = Model.PricesCollection.ToList(); }
                @for (int i = 0; i < pricesList.Count; i++)
                {
                    <div class="col-md-3">
                        <label>@pricesList[i].PriceType</label>
                        <input type="hidden" name="PricesCollection[@i].id" value="@pricesList[i].id" />
                        <input type="hidden" name="PricesCollection[@i].PriceType" value="@pricesList[i].PriceType" />
                        <input type="number" step="0.01" name="PricesCollection[@i].Price" value="@pricesList[i].Price.ToString("F2").Replace(",",".")" class="form-control" />
                    </div>
                }
            </div>

            <!-- --- NOVA SEÇÃO: RECURSOS DO PLANO --- -->
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="fas fa-list-ul"></i> Recursos Disponíveis</h4>
                <button type="button" class="btn btn-info btn-sm" onclick="addNewResource()">
                    <i class="fas fa-plus"></i> Adicionar Recurso
                </button>
            </div>
            
            <p class="text-muted small">Liste o que está incluso neste produto (ex: "Suporte 24h", "5 Usuários", "Exportação PDF").</p>

            <div id="resources-container">
                @* 
                   Se houver recursos já preenchidos (ex: em caso de erro de validação que retorna a view),
                   eles serão renderizados aqui. Caso contrário, começa vazio.
                *@
                @{ var resList = Model.resourcesCollection?.ToList() ?? new List<Dtos.Resources>(); }
                
                @for (int i = 0; i < resList.Count; i++)
                {
                    <div class="row mb-2 resource-row" id="row-res-@i">
                        <div class="col-md-8">
                            <input type="text" name="resourcesCollection[@i].description" value="@resList[i].description" class="form-control" placeholder="Descrição do recurso" />
                        </div>
                        <div class="col-md-2">
                             <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="resourcesCollection[@i].active" value="true" @(resList[i].active ? "checked" : "")>
                                <label class="form-check-label">Ativo</label>
                                <!-- Hack para checkbox MVC enviar false se não marcado -->
                                <input type="hidden" name="resourcesCollection[@i].active" value="false" />
                            </div>
                        </div>
                        <div class="col-md-2 text-right">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeResource('row-res-@i')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>

        </div>
        <div class="card-footer">
            <button type="submit" class="btn btn-success">Salvar Produto Completo</button>
            <a asp-action="Index" class="btn btn-default float-right">Cancelar</a>
        </div>
    </form>
</div>

<!-- SCRIPT JAVASCRIPT PARA ADICIONAR CAMPOS DINAMICAMENTE -->
<script>
    // Contador para gerar índices únicos
    let resourceIndex = @(Model.resourcesCollection?.Count ?? 0);

    function addNewResource() {
        const container = document.getElementById('resources-container');
        
        // Cria o HTML da nova linha
        const html = `
            <div class="row mb-2 resource-row" id="row-res-${resourceIndex}">
                <div class="col-md-8">
                    <input type="text" name="resourcesCollection[${resourceIndex}].description" class="form-control" placeholder="Nova funcionalidade (ex: Suporte Premium)" required />
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" name="resourcesCollection[${resourceIndex}].active" value="true" checked>
                        <label class="form-check-label">Ativo</label>
                        <input type="hidden" name="resourcesCollection[${resourceIndex}].active" value="false" />
                    </div>
                </div>
                <div class="col-md-2 text-right">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeResource('row-res-${resourceIndex}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;

        // Adiciona ao final do container
        container.insertAdjacentHTML('beforeend', html);
        resourceIndex++;
    }

    function removeResource(rowId) {
        const row = document.getElementById(rowId);
        if (row) {
            row.remove();
        }
    }
</script>