@using Enums
@model Dtos.Product

@{
    ViewData["Title"] = "Editar Produto";
}

<div class="card card-warning">
    <div class="card-header">
        <h3 class="card-title">Editar Produto: @Model.name</h3>
    </div>
    <!-- Aponta para a Action Edit do Controller -->
    <form asp-action="Edit" id="formProduct">
        
        <!-- CAMPO OCULTO OBRIGATÓRIO: O ID do Produto deve ser enviado para saber qual atualizar -->
        <input type="hidden" asp-for="id" />

        <div class="card-body">
            
            <!-- Dados Básicos -->
            <div class="form-group">
                <label>Nome do Produto</label>
                <input asp-for="name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Descrição</label>
                <textarea asp-for="description" class="form-control" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <select asp-for="category" class="form-control" asp-items="Html.GetEnumSelectList<ProductCategory>()"></select>
            </div>

            <hr />
            <h4>Preços</h4>
            <div class="row mb-4">
                @{ var pricesList = Model.PricesCollection.ToList(); }
                @for (int i = 0; i < pricesList.Count; i++)
                {
                    <div class="col-md-3">
                        <div class="card card-outline card-secondary">
                            <div class="card-header p-2">
                                <h6 class="card-title text-sm font-weight-bold">@pricesList[i].PriceType</h6>
                            </div>
                            <div class="card-body p-2">
                                <!-- Mantém o ID e o Tipo do preço original -->
                                <input type="hidden" name="PricesCollection[@i].id" value="@pricesList[i].id" />
                                <input type="hidden" name="PricesCollection[@i].PriceType" value="@pricesList[i].PriceType" />
                                
                                <div class="input-group input-group-sm">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">R$</span>
                                    </div>
                                    <input type="number" step="0.01" 
                                           name="PricesCollection[@i].Price" 
                                           value="@pricesList[i].Price.ToString("F2").Replace(",",".")" 
                                           class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- --- RECURSOS DO PLANO --- -->
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="fas fa-list-ul"></i> Recursos</h4>
                <button type="button" class="btn btn-info btn-sm" onclick="addNewResource()">
                    <i class="fas fa-plus"></i> Adicionar Recurso
                </button>
            </div>

            <div id="resources-container">
                @* Renderiza os recursos JÁ EXISTENTES no banco *@
                @{ var resList = Model.resourcesCollection?.ToList() ?? new List<Dtos.Resources>(); }
                
                @for (int i = 0; i < resList.Count; i++)
                {
                    <div class="row mb-2 resource-row" id="row-res-@i">
                        <!-- ID do recurso existente -->
                        <input type="hidden" name="resourcesCollection[@i].id" value="@resList[i].id" />

                        <div class="col-md-8">
                            <input type="text" name="resourcesCollection[@i].description" value="@resList[i].description" class="form-control" placeholder="Descrição do recurso" />
                        </div>
                        <div class="col-md-2">
                             <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="resourcesCollection[@i].active" value="true" @(resList[i].active ? "checked" : "")>
                                <label class="form-check-label">Ativo</label>
                                <input type="hidden" name="resourcesCollection[@i].active" value="false" />
                            </div>
                        </div>
                        <div class="col-md-2 text-right">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeResource('row-res-@i')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>

        </div>
        <div class="card-footer">
            <button type="submit" class="btn btn-warning">Atualizar Produto</button>
            <a asp-action="Index" class="btn btn-default float-right">Cancelar</a>
        </div>
    </form>
</div>

<!-- SCRIPT JAVASCRIPT -->
<script>
    // IMPORTANTE: O contador inicia baseado em quantos itens já existem para não sobrescrever índices
    let resourceIndex = @(Model.resourcesCollection?.Count ?? 0);

    function addNewResource() {
        const container = document.getElementById('resources-container');
        
        const html = `
            <div class="row mb-2 resource-row" id="row-res-${resourceIndex}">
                <div class="col-md-8">
                    <input type="text" name="resourcesCollection[${resourceIndex}].description" class="form-control" placeholder="Novo recurso..." required />
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" name="resourcesCollection[${resourceIndex}].active" value="true" checked>
                        <label class="form-check-label">Ativo</label>
                        <input type="hidden" name="resourcesCollection[${resourceIndex}].active" value="false" />
                    </div>
                </div>
                <div class="col-md-2 text-right">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeResource('row-res-${resourceIndex}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', html);
        resourceIndex++;
    }

    function removeResource(rowId) {
        const row = document.getElementById(rowId);
        if (row) {
            row.remove();
        }
    }
</script>