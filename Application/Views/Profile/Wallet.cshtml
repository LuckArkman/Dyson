@model Dtos.WalletViewModel
@{
    ViewData["Title"] = "Smart Wallet & Trading";
    Layout = "_AdminLayout";
}

<!-- Wallet Overview Cards -->
<div class="row">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-gradient-primary">
            <div class="inner">
                <h3>@Model.TokenBalance.ToString("F4")</h3>
                <p>Tokens DTC Disponíveis</p>
            </div>
            <div class="icon">
                <i class="fas fa-coins"></i>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="small-box bg-gradient-success">
            <div class="inner">
                <h3>R$ @Model.TokenValue.ToString("F2")</h3>
                <p>Valor Total</p>
            </div>
            <div class="icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="small-box bg-gradient-warning">
            <div class="inner">
                <h3>@Model.StakedBalance.ToString("F4")</h3>
                <p>Tokens em Staking</p>
            </div>
            <div class="icon">
                <i class="fas fa-lock"></i>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="small-box bg-gradient-info">
            <div class="inner">
                <h3><span class="description-percentage text-success"><i class="fas fa-caret-up"></i> 17%</span></h3>
                <p>Variação 24h</p>
            </div>
            <div class="icon">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Trading Chart Section -->
    <div class="col-lg-8">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="far fa-chart-bar"></i>
                    Gráfico de Preços DTC/BRL
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button type="button" class="btn btn-tool" data-card-widget="maximize">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Time Range Selector -->
                <div class="btn-group btn-group-sm mb-3" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="updateChart('1H')">1H</button>
                    <button type="button" class="btn btn-outline-primary" onclick="updateChart('24H')">24H</button>
                    <button type="button" class="btn btn-outline-primary" onclick="updateChart('7D')">7D</button>
                    <button type="button" class="btn btn-outline-primary" onclick="updateChart('30D')">30D</button>
                    <button type="button" class="btn btn-outline-primary" onclick="updateChart('1Y')">1Y</button>
                </div>

                <canvas id="tradingChart" style="min-height: 350px; height: 350px; max-height: 350px;"></canvas>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col-sm-3 col-6">
                        <div class="description-block border-right">
                            <span class="description-percentage text-success">
                                <i class="fas fa-caret-up"></i> 17%
                            </span>
                            <h5 class="description-header">R$ @Model.CurrentTokenPrice.ToString("F2")</h5>
                            <span class="description-text">PREÇO ATUAL</span>
                        </div>
                    </div>
                    <div class="col-sm-3 col-6">
                        <div class="description-block border-right">
                            <h5 class="description-header text-success">R$ 6.50</h5>
                            <span class="description-text">MÁXIMA 24H</span>
                        </div>
                    </div>
                    <div class="col-sm-3 col-6">
                        <div class="description-block border-right">
                            <h5 class="description-header text-danger">R$ 5.20</h5>
                            <span class="description-text">MÍNIMA 24H</span>
                        </div>
                    </div>
                    <div class="col-sm-3 col-6">
                        <div class="description-block">
                            <h5 class="description-header">1.2M</h5>
                            <span class="description-text">VOLUME 24H</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row">
            <div class="col-md-4">
                <button class="btn btn-success btn-block btn-lg" data-toggle="modal" data-target="#modalBuy">
                    <i class="fas fa-arrow-down"></i> COMPRAR
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-danger btn-block btn-lg" data-toggle="modal" data-target="#modalSell">
                    <i class="fas fa-arrow-up"></i> VENDER
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-warning btn-block btn-lg text-dark" data-toggle="modal" data-target="#modalStake">
                    <i class="fas fa-lock"></i> STAKE
                </button>
            </div>
        </div>
    </div>

    <!-- Wallet Info Section -->
    <div class="col-lg-4">
        <!-- Wallet Address Card -->
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-wallet"></i> Minha Carteira
                </h3>
            </div>
            <div class="card-body box-profile">
                <div class="text-center mb-3">
                    <i class="fas fa-ethereum fa-5x text-primary"></i>
                </div>

                <h5 class="text-center">@Model.TokenBalance.ToString("F4") DTC</h5>
                <p class="text-muted text-center">Saldo Disponível</p>

                <hr>

                <p><strong><i class="fas fa-lock mr-2"></i> Em Staking</strong></p>
                <p class="text-muted">@Model.StakedBalance.ToString("F4") DTC</p>

                <hr>

                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt mr-2"></i> Endereço da Carteira</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" value="@Model.WalletAddress" readonly id="walletAddress">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-info" onclick="copyWalletAddress()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.WalletAddress))
                {
                    <a href="#" class="btn btn-primary btn-block">
                        <i class="fas fa-qrcode"></i> <b>Ver QR Code</b>
                    </a>
                }
                else
                {
                    <button class="btn btn-warning btn-block" onclick="linkMetaMaskWallet()">
                        <i class="fab fa-ethereum"></i> <b>Conectar MetaMask</b>
                    </button>
                }
            </div>
        </div>
        
        <!-- Market Insights -->
        <div class="card card-info card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-lightbulb"></i> Insights do Mercado
                </h3>
            </div>
            <div class="card-body">
                <p class="text-success">
                    <i class="fas fa-arrow-up"></i> <strong>Tendência de Alta</strong>
                </p>
                <p class="small">O mercado está em movimento ascendente. Pode ser um bom momento para:</p>
                <ul class="small">
                    <li>Fazer HODL (manter tokens)</li>
                    <li>Considerar stake para rendimentos passivos</li>
                    <li>Vender apenas se atingir meta de lucro</li>
                </ul>

                <div class="progress-group">
                    <span class="progress-text">Volume 24h</span>
                    <span class="float-right"><b>1.2M</b>/2M</span>
                    <div class="progress progress-sm">
                        <div class="progress-bar bg-success" style="width: 60%"></div>
                    </div>
                </div>

                <div class="progress-group">
                    <span class="progress-text">Capitalização</span>
                    <span class="float-right"><b>85%</b></span>
                    <div class="progress progress-sm">
                        <div class="progress-bar bg-primary" style="width: 85%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Staking Info -->
        <div class="card card-warning card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-percentage"></i> Taxas de Staking
                </h3>
            </div>
            <div class="card-body p-0">
                <table class="table">
                    <tbody>
                        <tr>
                            <td><strong>30 Dias</strong></td>
                            <td><span class="badge badge-success">5% APY</span></td>
                        </tr>
                        <tr>
                            <td><strong>90 Dias</strong></td>
                            <td><span class="badge badge-warning">12% APY</span></td>
                        </tr>
                        <tr>
                            <td><strong>1 Ano</strong></td>
                            <td><span class="badge badge-danger">30% APY</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Transaction History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history"></i> Histórico de Transações
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover text-nowrap">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Quantidade</th>
                            <th>Preço</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>09/12/2024 14:30</td>
                            <td><span class="badge badge-success">Compra</span></td>
                            <td>100.00 DTC</td>
                            <td>R$ 5.50</td>
                            <td>R$ 550.00</td>
                            <td><i class="fas fa-check text-success"></i> Completo</td>
                        </tr>
                        <tr>
                            <td>08/12/2024 10:15</td>
                            <td><span class="badge badge-warning">Stake</span></td>
                            <td>50.00 DTC</td>
                            <td>-</td>
                            <td>30 dias</td>
                            <td><i class="fas fa-lock text-warning"></i> Bloqueado</td>
                        </tr>
                        <tr>
                            <td>07/12/2024 16:45</td>
                            <td><span class="badge badge-danger">Venda</span></td>
                            <td>25.00 DTC</td>
                            <td>R$ 5.20</td>
                            <td>R$ 130.00</td>
                            <td><i class="fas fa-check text-success"></i> Completo</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer clearfix">
                <button class="btn btn-sm btn-secondary float-right">Ver Tudo</button>
            </div>
        </div>
    </div>
</div>

<!-- Buy Modal -->
<div class="modal fade" id="modalBuy">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h4 class="modal-title">
                    <i class="fas fa-arrow-down"></i> Comprar Tokens DTC
                </h4>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Quantidade (DTC)</label>
                    <input type="number" class="form-control" id="buyAmount" placeholder="0.00" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Preço Unitário</label>
                    <input type="text" class="form-control" value="R$ @Model.CurrentTokenPrice.ToString("F2")" readonly>
                </div>
                <div class="form-group">
                    <label>Total a Pagar</label>
                    <input type="text" class="form-control" id="buyTotal" value="R$ 0.00" readonly>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Taxa:</strong> 0.5% sobre o valor da transação
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="trade('BUY')">
                    <i class="fas fa-check"></i> Confirmar Compra
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sell Modal -->
<div class="modal fade" id="modalSell">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h4 class="modal-title">
                    <i class="fas fa-arrow-up"></i> Vender Tokens DTC
                </h4>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Quantidade (DTC)</label>
                    <input type="number" class="form-control" id="sellAmount" placeholder="0.00" min="0" step="0.01" max="@Model.TokenBalance">
                    <small class="form-text text-muted">
                        Disponível: @Model.TokenBalance.ToString("F4") DTC
                    </small>
                </div>
                <div class="form-group">
                    <label>Preço Unitário</label>
                    <input type="text" class="form-control" value="R$ @Model.CurrentTokenPrice.ToString("F2")" readonly>
                </div>
                <div class="form-group">
                    <label>Total a Receber</label>
                    <input type="text" class="form-control" id="sellTotal" value="R$ 0.00" readonly>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Taxa:</strong> 0.5% sobre o valor da transação
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="trade('SELL')">
                    <i class="fas fa-check"></i> Confirmar Venda
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stake Modal -->
<div class="modal fade" id="modalStake">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h4 class="modal-title text-dark">
                    <i class="fas fa-lock"></i> Fazer Stake (Renda Passiva)
                </h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    Stake seus tokens e ganhe recompensas! Os tokens ficam bloqueados durante o período escolhido.
                </div>

                <div class="form-group">
                    <label>Quantidade (DTC)</label>
                    <input type="number" id="stakeAmount" class="form-control" placeholder="0.00" min="0" step="0.01" max="@Model.TokenBalance">
                    <small class="form-text text-muted">
                        Disponível: @Model.TokenBalance.ToString("F4") DTC
                    </small>
                </div>

                <div class="form-group">
                    <label>Duração</label>
                    <select id="stakeDuration" class="form-control">
                        <option value="30">30 Dias (5% APY)</option>
                        <option value="90" selected>90 Dias (12% APY) - Recomendado</option>
                        <option value="365">1 Ano (30% APY)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Recompensa Estimada</label>
                    <input type="text" class="form-control" id="stakeReward" value="0.00 DTC" readonly>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning text-dark" onclick="submitStake()">
                    <i class="fas fa-lock"></i> Confirmar Stake
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/metamask-auth.js"></script>
    <script>
        const currentPrice = @Model.CurrentTokenPrice;

        $(function () {
            // Initialize Chart
            initializeChart();

            // Calculate totals on input
            $('#buyAmount').on('input', function() {
                const amount = parseFloat($(this).val()) || 0;
                const total = amount * currentPrice;
                $('#buyTotal').val('R$ ' + total.toFixed(2));
            });

            $('#sellAmount').on('input', function() {
                const amount = parseFloat($(this).val()) || 0;
                const total = amount * currentPrice;
                $('#sellTotal').val('R$ ' + total.toFixed(2));
            });

            $('#stakeAmount, #stakeDuration').on('input change', function() {
                calculateStakeReward();
            });
        });

        function initializeChart() {
            $.get('/Profile/GetChartData', function(response) {
                var ctx = document.getElementById('tradingChart').getContext('2d');
                window.tradingChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: response.labels || ['1h', '2h', '3h', '4h', '5h', '6h'],
                        datasets: [{
                            label: 'Preço DTC (BRL)',
                            data: response.data || [5.2, 5.3, 5.4, 5.5, 5.6, 5.5],
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { 
                                grid: { color: '#444' },
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toFixed(2);
                                    }
                                }
                            },
                            x: { grid: { color: '#444' } }
                        },
                        plugins: {
                            legend: { labels: { color: 'white' } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Preço: R$ ' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        function updateChart(timeRange) {
            // Update chart based on time range
            console.log('Updating chart for:', timeRange);
            // Implement actual data fetch here
        }

        function submitStake() {
            var amount = parseFloat($('#stakeAmount').val());
            var days = parseInt($('#stakeDuration').val());
            
            if (!amount || amount <= 0) {
                alert('Digite uma quantidade válida');
                return;
            }

            fetch('/Profile/StakeTokens', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: amount, durationDays: days })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    $('#modalStake').modal('hide');
                    $(document).Toasts('create', {
                        class: 'bg-success',
                        title: 'Stake Realizado!',
                        body: data.message,
                        autohide: true,
                        delay: 3000
                    });
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert(data.message);
                }
            });
        }

        function trade(type) {
            var inputId = type === 'BUY' ? '#buyAmount' : '#sellAmount';
            var amount = parseFloat($(inputId).val());

            if (!amount || amount <= 0) {
                alert('Digite uma quantidade válida');
                return;
            }

            fetch('/Profile/TradeTokens', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type, amount: amount })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    const modalId = type === 'BUY' ? '#modalBuy' : '#modalSell';
                    $(modalId).modal('hide');
                    $(document).Toasts('create', {
                        class: type === 'BUY' ? 'bg-success' : 'bg-danger',
                        title: type === 'BUY' ? 'Compra Realizada!' : 'Venda Realizada!',
                        body: data.message,
                        autohide: true,
                        delay: 3000
                    });
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert(data.message);
                }
            });
        }

        function calculateStakeReward() {
            const amount = parseFloat($('#stakeAmount').val()) || 0;
            const duration = parseInt($('#stakeDuration').val());
            let apy = 0;

            switch(duration) {
                case 30: apy = 0.05; break;
                case 90: apy = 0.12; break;
                case 365: apy = 0.30; break;
            }

            const reward = amount * apy;
            $('#stakeReward').val(reward.toFixed(4) + ' DTC');
        }

        function copyWalletAddress() {
            const input = document.getElementById('walletAddress');
            input.select();
            document.execCommand('copy');
            
            $(document).Toasts('create', {
                class: 'bg-success',
                title: 'Copiado!',
                body: 'Endereço copiado para área de transferência.',
                autohide: true,
                delay: 2000
            });
        }

        async function linkMetaMaskWallet() {
            // Implementation from metamask-auth.js
            console.log('Linking MetaMask wallet...');
        }
    </script>
}
