@model Models.Web3CheckoutViewModel
@{
    ViewData["Title"] = "Checkout Arc - USDC";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="space-y-8 p-4 md:p-8 max-w-6xl mx-auto min-h-screen pt-24">
    <div class="flex items-center justify-center mb-6">
        <h1 class="text-4xl font-extrabold text-white text-center">Pagamento via Arc Network</h1>
        <span class="ml-3 px-3 py-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-xs font-bold rounded-full uppercase">Powered by Circle</span>
    </div>

    <!-- Status Connection -->
    <div id="connection-status" class="bg-secondary-dark p-4 rounded-xl border border-gray-800 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
            <span id="status-text" class="text-gray-400">Conecte sua carteira MetaMask</span>
        </div>
        <button id="connectWalletBtn" onclick="connectWallet()" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:opacity-90 text-white font-bold rounded-lg transition shadow-lg">
            <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Conectar MetaMask
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- √Årea Principal -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Resumo dos Itens -->
            <div class="bg-secondary-dark p-6 rounded-2xl shadow-lg border border-gray-800">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-accent-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                    Resumo do Carrinho
                </h2>
                <ul class="space-y-3">
                    @foreach (var item in Model.CartItems)
                    {
                        <li class="flex justify-between items-center text-gray-300 bg-gray-800/50 p-3 rounded-lg">
                            <span>@item.ProductName <span class="text-xs text-gray-500">x @item.Quantity</span></span>
                            <span class="text-white font-bold">@((item.Price * item.Quantity).ToString("C2"))</span>
                        </li>
                    }
                </ul>
            </div>

            <!-- Informa√ß√µes Arc Network -->
            <div class="bg-secondary-dark p-6 rounded-2xl shadow-lg border border-gray-800">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Arc Network by Circle
                </h2>
                
                <div class="space-y-4">
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <label class="text-sm text-gray-400">Chain ID:</label>
                        <code class="text-sm text-green-400 bg-gray-900 px-3 py-2 rounded font-mono block mt-1">
                            @Model.ChainId
                        </code>
                    </div>

                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <label class="text-sm text-gray-400">Endere√ßo de Destino:</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <code class="text-xs text-blue-400 bg-gray-900 px-3 py-2 rounded font-mono flex-1 overflow-x-auto">
                                @Model.RecipientAddress
                            </code>
                            <button onclick="copyToClipboard('@Model.RecipientAddress')" class="text-gray-400 hover:text-white">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <label class="text-sm text-gray-400">Rede:</label>
                        <p class="text-white font-semibold mt-1">Arc Testnet</p>
                    </div>

                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <label class="text-sm text-gray-400">Gas Token:</label>
                        <p class="text-white font-semibold mt-1">USDC (Native)</p>
                        <p class="text-xs text-gray-500 mt-1">Taxas previs√≠veis em d√≥lares</p>
                    </div>
                </div>

                <!-- Caracter√≠sticas Arc -->
                <div class="mt-4 bg-gradient-to-r from-blue-900/20 to-purple-900/20 border border-blue-800/50 rounded-lg p-4">
                    <h4 class="text-blue-300 font-semibold mb-2">Por que Arc?</h4>
                    <ul class="text-sm text-blue-200 space-y-1">
                        <li>‚ö° Finalidade sub-segundo (~1s)</li>
                        <li>üí∞ Gas em USDC (previs√≠vel)</li>
                        <li>üè¶ Enterprise-grade da Circle</li>
                        <li>üîí Privacidade configur√°vel</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Resumo Lateral -->
        <div class="lg:col-span-1">
            <div class="bg-secondary-dark p-6 rounded-2xl shadow-xl border border-gray-800 sticky top-24">
                <h3 class="text-xl font-bold text-white mb-6">Total a Pagar</h3>
                
                <div class="space-y-4 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Subtotal</span>
                        <span class="text-white font-semibold">@Model.TotalAmount.ToString("C2")</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Valor em USDC</span>
                        <span class="text-white font-semibold">$@Model.TotalAmount.ToString("F2")</span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-500">Taxa estimada (gas)</span>
                        <span class="text-green-400 font-semibold" id="estimatedGas">~$0.01</span>
                    </div>
                    <div class="border-t border-gray-700 pt-4">
                        <div class="flex justify-between items-end">
                            <span class="text-gray-400">Total</span>
                            <span class="text-3xl font-extrabold text-white">$@Model.TotalAmount.ToString("F2")</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">‚âà @Model.TotalAmount.ToString("C2") BRL</p>
                    </div>
                </div>

                <!-- Wallet Info -->
                <div id="walletInfo" class="hidden mb-4 p-3 bg-gray-800/50 rounded-lg">
                    <p class="text-xs text-gray-400 mb-1">Carteira Conectada:</p>
                    <code id="walletAddress" class="text-xs text-green-400 break-all block mb-2"></code>
                    <p class="text-xs text-gray-400">Saldo USDC:</p>
                    <p id="usdcBalance" class="text-white font-semibold">Carregando...</p>
                </div>
                
                <button onclick="processPayment()" id="btnPayment" disabled class="w-full py-4 px-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold rounded-xl shadow-lg hover:opacity-90 transition transform hover:-translate-y-1 flex justify-center items-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span>Pagar com USDC</span>
                </button>

                <div class="mt-4 text-center">
                    <p class="text-xs text-gray-500 mb-2">Pagamento processado via</p>
                    <div class="flex justify-center items-center space-x-2">
                        <span class="font-bold text-white">Arc Network</span>
                        <span class="text-gray-500">by</span>
                        <span class="font-bold text-blue-400">Circle</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Progresso -->
<div id="progressModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-secondary-dark p-8 rounded-2xl max-w-md w-full mx-4 border border-gray-800">
        <div class="text-center">
            <div class="mb-4">
                <svg class="animate-spin h-16 w-16 text-purple-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-white mb-2" id="progressTitle">Processando Pagamento</h3>
            <p class="text-gray-400" id="progressMessage">Aguarde...</p>
            <div class="mt-6 space-y-2">
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-400">1. Conectando √† Arc</span>
                    <span id="step1" class="text-gray-500">‚è≥</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-400">2. Confirmando no MetaMask</span>
                    <span id="step2" class="text-gray-500">‚è≥</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-400">3. Processando blockchain</span>
                    <span id="step3" class="text-gray-500">‚è≥</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-400">4. Finalizando pedido</span>
                    <span id="step4" class="text-gray-500">‚è≥</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
    // Configura√ß√µes Arc
    const RECIPIENT_ADDRESS = '@Model.RecipientAddress';
    const AMOUNT_USD = @Model.TotalAmount;
    const ARC_CHAIN_ID = '@Model.ChainId'; // 5042002 para testnet
    
    // Configura√ß√µes da rede Arc Testnet
    const ARC_NETWORK = {
        chainId: '0x' + parseInt(ARC_CHAIN_ID).toString(16),
        chainName: 'Arc Testnet',
        nativeCurrency: {
            name: 'USDC',
            symbol: 'USDC',
            decimals: 6 // USDC tem 6 decimais
        },
        rpcUrls: ['https://arc-testnet.drpc.org'],
        blockExplorerUrls: ['https://testnet.arcscan.app']
    };

    let provider = null;
    let signer = null;
    let userAddress = null;

    // Conectar MetaMask
    async function connectWallet() {
        try {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask n√£o detectado! Instale a extens√£o MetaMask.');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            updateStatus('Conectando...', 'yellow');

            // Solicitar contas
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            userAddress = accounts[0];

            // Criar provider
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();

            // Verificar/Adicionar rede Arc
            await switchToArcNetwork();

            // Atualizar UI
            updateStatus('Conectado', 'green');
            document.getElementById('walletAddress').textContent = 
                `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
            document.getElementById('walletInfo').classList.remove('hidden');
            document.getElementById('connectWalletBtn').textContent = 'Conectado ‚úì';
            document.getElementById('connectWalletBtn').disabled = true;
            document.getElementById('btnPayment').disabled = false;

            // Verificar saldo
            await checkBalance();

            // Estimar gas
            await estimateGas();

            // Iniciar transa√ß√£o no backend
            await initiateTransaction();

        } catch (error) {
            console.error('Erro ao conectar:', error);
            alert('Erro ao conectar: ' + error.message);
            updateStatus('Erro na conex√£o', 'red');
        }
    }

    // Mudar para rede Arc
    async function switchToArcNetwork() {
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: ARC_NETWORK.chainId }]
            });
        } catch (error) {
            // Se a rede n√£o existe, adicionar
            if (error.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [ARC_NETWORK]
                    });
                } catch (addError) {
                    throw new Error('Erro ao adicionar rede Arc: ' + addError.message);
                }
            } else {
                throw error;
            }
        }
    }

    // Verificar saldo USDC
    async function checkBalance() {
        try {
            const balance = await provider.getBalance(userAddress);
            // Converter de wei para USDC (6 decimais)
            const balanceUsdc = ethers.utils.formatUnits(balance, 6);
            
            document.getElementById('usdcBalance').textContent = `${parseFloat(balanceUsdc).toFixed(2)} USDC`;

            if (parseFloat(balanceUsdc) < AMOUNT_USD) {
                alert(`Saldo insuficiente!\nVoc√™ tem: ${balanceUsdc} USDC\nNecess√°rio: ${AMOUNT_USD} USDC\n\nObtenha USDC em: https://testnet.arcscan.app/faucet`);
                document.getElementById('btnPayment').disabled = true;
            }
        } catch (error) {
            console.error('Erro ao verificar saldo:', error);
            document.getElementById('usdcBalance').textContent = 'Erro';
        }
    }

    // Estimar taxa de gas
    async function estimateGas() {
        try {
            const amountWei = ethers.utils.parseUnits(AMOUNT_USD.toString(), 6);
            
            const gasEstimate = await provider.estimateGas({
                from: userAddress,
                to: RECIPIENT_ADDRESS,
                value: amountWei
            });

            const gasPrice = await provider.getGasPrice();
            const totalGas = gasEstimate.mul(gasPrice);
            const gasFeeUsdc = ethers.utils.formatUnits(totalGas, 6);
            
            document.getElementById('estimatedGas').textContent = `~$${parseFloat(gasFeeUsdc).toFixed(4)}`;
        } catch (error) {
            console.error('Erro ao estimar gas:', error);
        }
    }

    // Iniciar transa√ß√£o no backend
    async function initiateTransaction() {
        try {
            const response = await fetch('/Web3Payment/InitiateTransaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ walletAddress: userAddress })
            });

            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }

            window.currentOrderId = result.orderId;
        } catch (error) {
            console.error('Erro ao iniciar:', error);
            alert('Erro: ' + error.message);
        }
    }

    // Processar pagamento
    async function processPayment() {
        try {
            showModal();
            updateProgress(1, '‚úì');

            // Converter valor para wei (6 decimais para USDC)
            const amountWei = ethers.utils.parseUnits(AMOUNT_USD.toString(), 6);

            updateProgress(2, '‚è≥');
            document.getElementById('progressMessage').textContent = 'Confirme a transa√ß√£o no MetaMask...';

            // Enviar transa√ß√£o
            const tx = await signer.sendTransaction({
                to: RECIPIENT_ADDRESS,
                value: amountWei
            });

            updateProgress(2, '‚úì');
            updateProgress(3, '‚è≥');
            document.getElementById('progressMessage').textContent = 'Aguardando confirma√ß√£o (1-2 segundos)...';

            // Aguardar confirma√ß√£o (Arc √© r√°pido!)
            const receipt = await tx.wait();

            updateProgress(3, '‚úì');
            updateProgress(4, '‚è≥');
            document.getElementById('progressMessage').textContent = 'Finalizando pedido...';

            // Confirmar no backend
            const confirmResponse = await fetch('/Web3Payment/ConfirmTransaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    orderId: window.currentOrderId,
                    transactionHash: receipt.transactionHash,
                    network: 'Arc'
                })
            });

            const confirmResult = await confirmResponse.json();

            if (confirmResult.success) {
                updateProgress(4, '‚úì');
                document.getElementById('progressTitle').textContent = 'Pagamento Confirmado!';
                document.getElementById('progressMessage').textContent = 'Redirecionando...';
                
                setTimeout(() => {
                    window.location.href = confirmResult.redirectUrl;
                }, 2000);
            } else {
                throw new Error(confirmResult.message);
            }

        } catch (error) {
            console.error('Erro no pagamento:', error);
            hideModal();
            
            if (error.code === 4001) {
                alert('Transa√ß√£o cancelada.');
            } else {
                alert('Erro: ' + error.message);
            }
        }
    }

    // Fun√ß√µes auxiliares
    function updateStatus(text, color) {
        document.getElementById('status-text').textContent = text;
        document.getElementById('status-indicator').className = `w-3 h-3 rounded-full bg-${color}-500`;
    }

    function showModal() {
        document.getElementById('progressModal').classList.remove('hidden');
    }

    function hideModal() {
        document.getElementById('progressModal').classList.add('hidden');
    }

    function updateProgress(step, status) {
        document.getElementById(`step${step}`).textContent = status;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
        alert('Copiado!');
    }

    // Detectar mudan√ßas
    if (window.ethereum) {
        window.ethereum.on('accountsChanged', () => location.reload());
        window.ethereum.on('chainChanged', () => location.reload());
    }
</script>
}

<style>
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }
</style>