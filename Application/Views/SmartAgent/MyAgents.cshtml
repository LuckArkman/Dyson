@model IEnumerable<Dtos.SmartAgent>
@{
Layout = "~/Views/Shared/_AdminLayout.cshtml";
ViewData["Title"] = "Meus Agentes";
}

<div class="row mb-4">
    <div class="col-md-6">
        <h3 class="m-0 text-dark-mode">Biblioteca de Agentes</h3>
        <p class="text-muted">Gerencie e execute seus fluxos automatizados.</p>
    </div>
    <div class="col-md-6 text-right">
        <a asp-action="Make" class="btn btn-primary btn-lg shadow">
            <i class="fas fa-plus-circle mr-2"></i> Criar Novo Agente
        </a>
    </div>
</div>

<div class="row">
    @foreach (var agent in Model)
    {
    <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch flex-column">
        <div class="card bg-dark d-flex flex-fill animate__animated animate__fadeIn">
            <div class="card-header border-bottom-0 text-muted small">
                <i class="fas fa-fingerprint"></i> ID: @agent.id.Substring(0, 8)...
                <div class="card-tools">
                    @if(agent.IsPublic) { <span class="badge badge-success">Público</span> }
                    else { <span class="badge badge-secondary">Privado</span> }
                </div>
            </div>

            <div class="card-body pt-0">
                <div class="row">
                    <div class="col-12 text-center mt-3 mb-3">
                        <!-- Ícone Dinâmico baseado na categoria/nome -->
                        <div class="bg-gradient-primary rounded-circle d-inline-flex justify-content-center align-items-center" style="width:60px; height:60px;">
                            <i class="fas fa-robot fa-2x"></i>
                        </div>
                    </div>
                    <div class="col-12 text-center">
                        <h2 class="lead"><b>@agent.Name</b></h2>
                        <p class="text-muted text-sm">
                            <b>Categoria: </b> @(agent.Category ?? "Geral") <br/>
                            <b>Nós: </b> @(agent.Workflow?.Nodes?.Count ?? 0) blocos
                        </p>
                        <p class="text-muted text-sm px-3">
                            @(string.IsNullOrEmpty(agent.Description) ? "Sem descrição definida." : agent.Description)
                        </p>
                    </div>
                </div>
            </div>

            <div class="card-footer">
                <div class="row">
                    <div class="col-6">
                        <a asp-action="Make" asp-route-id="@agent.id" class="btn btn-sm btn-info btn-block">
                            <i class="fas fa-edit mr-1"></i> Editar
                        </a>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-sm btn-success btn-block" onclick="runAgent('@agent.id')">
                            <i class="fas fa-play mr-1"></i> Executar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }

    @if (!Model.Any())
    {
    <div class="col-12">
        <div class="alert alert-secondary text-center" role="alert">
            <i class="fas fa-info-circle fa-2x mb-3"></i><br/>
            <h5>Você ainda não possui agentes.</h5>
            <p>Clique no botão "Criar Novo Agente" para começar.</p>
        </div>
    </div>
    }
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function runAgent(id) {
        Swal.fire({
            title: 'Executar Workflow',
            text: 'Deseja disparar este agente manualmente?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sim, Executar!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Simulação de chamada de API
                // Em produção: fetch(`/api/SmartAgents/${id}/execute`, { method: 'POST' })

                let timerInterval;
                Swal.fire({
                    title: 'Executando...',
                    html: 'Processando nós do workflow.',
                    timer: 2000,
                    timerProgressBar: true,
                    didOpen: () => { Swal.showLoading(); },
                    willClose: () => { clearInterval(timerInterval); }
                }).then((result) => {
                    Swal.fire('Concluído!', 'Execução finalizada com sucesso.', 'success');
                });
            }
        });
    }
</script>
}